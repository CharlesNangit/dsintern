<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Send Report</title>
    <style>
        /* General Styles */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background-color: #fff;
            color: #000;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        header {
            background-color: #3b9b3b;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 40px;
        }

        header h1 {
            font-size: 28px;
            margin: 0;
        }

        header h2 {
            font-size: 20px;
            margin: 0;
            font-weight: normal;
        }

        main {
            flex: 1;
            padding: 40px 20px 100px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-y: auto;
        }

        h2 {
            font-size: 26px;
            font-weight: bold;
            margin-bottom: 20px;
        }

        /* Recipients and Subject */
        .top-section {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            gap: 30px;
            width: 90%;
            margin-bottom: 15px;
        }

        .dropdown-container {
            position: relative;
            width: 350px;
        }

        .dropdown-selected, .subject-input {
            border: 1px solid #000;
            border-radius: 20px;
            padding: 10px 15px;
            width: 100%;
            font-size: 16px;
            cursor: pointer;
        }

        .dropdown-options {
            display: none;
            position: absolute;
            background: white;
            border: 1px solid #000;
            border-radius: 8px;
            width: 100%;
            max-height: 150px;
            overflow-y: auto;
            margin-top: 5px;
            z-index: 10;
        }

        .dropdown-options label {
            display: block;
            padding: 6px 12px;
            cursor: pointer;
        }

        .dropdown-options label:hover {
            background-color: #e6e6e6;
        }

        .chips-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            width: 90%;
            border: 1px solid #000;
            border-radius: 30px;
            padding: 10px;
            min-height: 40px;
            margin-bottom: 30px;
        }

        .chip {
            background-color: #e0e0e0;
            border-radius: 20px;
            padding: 6px 14px;
            display: flex;
            align-items: center;
            font-size: 15px;
        }

        .chip span {
            margin-left: 8px;
            cursor: pointer;
            color: red;
            font-weight: bold;
        }

        /* Table */
        table {
            border-collapse: collapse;
            width: 90%;
            margin-bottom: 30px;
        }

        th, td {
            border: 2px solid black;
            text-align: left;
            padding: 10px;
            font-size: 16px;
        }

        th {
            width: 30%;
            font-weight: bold;
        }

        td input, td textarea {
            width: 95%;
            padding: 8px;
            border: 1px solid #aaa;
            border-radius: 20px;
            font-size: 15px;
        }

        textarea {
            resize: vertical;
            height: 60px;
        }

        .remove-row {
            color: red;
            font-weight: bold;
            cursor: pointer;
            margin-right: 10px;
        }

        /* Image Upload Area */
        .upload-box {
            border: 2px dashed #999;
            border-radius: 10px;
            width: 90%;
            padding: 20px;
            text-align: center;
            margin-bottom: 30px;
        }

        .upload-box:hover {
            background-color: #f5f5f5;
        }

        /* Buttons */
        .button-row {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
        }

        .green-btn {
            background-color: #3b9b3b;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 10px 25px;
            font-size: 16px;
            cursor: pointer;
            text-decoration: none;
            font-weight: bold;
        }

        .green-btn:hover {
            background-color: #338633;
        }

        /* Footer */
        footer {
            background-color: #3b9b3b;
            height: 35px;
            position: fixed;
            bottom: 0;
            width: 100%;
        }

        @media (max-width: 768px) {
            .top-section {
                flex-direction: column;
                gap: 10px;
            }

            table {
                width: 100%;
            }

            .upload-box {
                width: 100%;
            }
        }
    </style>
</head>
<body>

    <header>
        <h1>InternDesk</h1>
        <h2>Report Email</h2>
    </header>

    <main>
        <h2>Submit Power-On / Diagnostic Report</h2>

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            <ul>
              {% for category, message in messages %}
                <li><strong>{{ category }}:</strong> {{ message }}</li>
              {% endfor %}
            </ul>
          {% endif %}
        {% endwith %}

        <form action="{{ url_for('send_report') }}" method="POST" enctype="multipart/form-data" id="reportForm">

            <div class="top-section">
                <div class="dropdown-container">
                    <div class="dropdown-selected" onclick="toggleDropdown()">Select Engineer Email</div>
                    <div class="dropdown-options">
                        {% for r in recipients %}
                        <label><input type="checkbox" name="recipients" value="{{ r.email }}"> {{ r.email }}</label>
                        {% endfor %}
                    </div>
                </div>
                <input type="text" name="subject" class="subject-input" placeholder="Provide Subject" required>
            </div>

            <div class="chips-container" id="chipsContainer"></div>

            <div class="button-row">
                <button type="reset" class="green-btn">Return to Default</button>
            </div>

            <table id="reportTable">
                <tr><th><span class="remove-row" onclick="removeRow(this)">×</span>Model Name</th><td><input type="text" name="model" placeholder="Provide the model name here" required></td></tr>
                <tr><th><span class="remove-row" onclick="removeRow(this)">×</span>Product Number / Serial Number</th><td><input type="text" name="serial" placeholder="Provide the product number / serial number here" required></td></tr>
                <tr><th><span class="remove-row" onclick="removeRow(this)">×</span>Processor</th><td><input type="text" name="processor" placeholder="Provide the processor name here" required></td></tr>
                <tr><th><span class="remove-row" onclick="removeRow(this)">×</span>RAM</th><td><input type="text" name="ram" placeholder="Provide the RAM size here" required></td></tr>
                <tr><th><span class="remove-row" onclick="removeRow(this)">×</span>Storage</th><td><input type="text" name="storage" placeholder="Provide the Storage size here" required></td></tr>
                <tr><th><span class="remove-row" onclick="removeRow(this)">×</span>Optical Disk</th><td><input type="text" name="optical" placeholder="Is there an optical disk? Type 'Yes' or 'No'" required></td></tr>
                <tr><th><span class="remove-row" onclick="removeRow(this)">×</span>Operating System</th><td><input type="text" name="os" placeholder="Provide the Operating System here" required></td></tr>
                <tr><th><span class="remove-row" onclick="removeRow(this)">×</span>Physical State</th><td><input type="text" name="physical" placeholder="Provide remarks about the physical state of the unit" required></td></tr>
                <tr><th><span class="remove-row" onclick="removeRow(this)">×</span>Diagnostic Result</th><td><textarea name="diagnostic" placeholder="Write diagnostic details or observations here..." required></textarea></td></tr>
                <tr><th><span class="remove-row" onclick="removeRow(this)">×</span>Specific Instruction</th><td><input type="text" name="instruction" placeholder="Provide specific instructions for the unit" required></td></tr>
                <tr><th><span class="remove-row" onclick="removeRow(this)">×</span>Checklist</th><td><input type="text" name="checklist" placeholder="Provide checklist remarks here" required></td></tr>
            </table>

            <div class="upload-box" id="uploadBox">
                <p>Drag & Drop or Paste image here</p>
                <input type="file" id="imageInput" name="image" accept="image/*" hidden>
                <button type="button" class="green-btn" onclick="document.getElementById('imageInput').click()">Choose Image</button>
                <input type="hidden" name="image_base64" id="imageBase64">
            </div>

            <p>Make sure all report details are filled before pressing send</p>
            <button type="submit" class="green-btn" style="align-self: flex-end;">Send Report</button>
        </form>
    </main>

    <footer></footer>

    <script>
        function toggleDropdown() {
            const dropdown = document.querySelector('.dropdown-options');
            dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
        }

        document.addEventListener('click', function(event) {
            const dropdown = document.querySelector('.dropdown-options');
            const selected = document.querySelector('.dropdown-selected');
            if (!selected.contains(event.target) && !dropdown.contains(event.target)) {
                dropdown.style.display = 'none';
            }
        });

        function removeRow(el) {
            el.closest('tr').remove();
        }

        const chipsContainer = document.getElementById('chipsContainer');
        const checkboxes = document.querySelectorAll('input[type=checkbox][name=recipients]');
        const selectedBox = document.querySelector('.dropdown-selected');

        checkboxes.forEach(cb => {
            cb.addEventListener('change', () => {
                const selectedEmails = Array.from(checkboxes).filter(c => c.checked).map(c => c.value);
                chipsContainer.innerHTML = '';
                selectedEmails.forEach(email => {
                    const chip = document.createElement('div');
                    chip.classList.add('chip');
                    chip.innerHTML = `${email} <span onclick="removeChip('${email}')">×</span>`;
                    chipsContainer.appendChild(chip);
                });
                selectedBox.textContent = selectedEmails.length ? 'Recipients Selected' : 'Select Engineer Email';
            });
        });

        function removeChip(email) {
            document.querySelector(`input[value="${email}"]`).checked = false;
            const event = new Event('change');
            document.querySelector(`input[value="${email}"]`).dispatchEvent(event);
        }

        // Image to Base64
        const uploadBox = document.getElementById('uploadBox');
        const imageInput = document.getElementById('imageInput');
        const imageBase64 = document.getElementById('imageBase64');

        uploadBox.addEventListener('click', () => imageInput.click());

        uploadBox.addEventListener('dragover', e => {
            e.preventDefault();
            uploadBox.style.backgroundColor = '#f0fff0';
        });

        uploadBox.addEventListener('dragleave', e => {
            uploadBox.style.backgroundColor = '';
        });

        uploadBox.addEventListener('drop', e => {
            e.preventDefault();
            uploadBox.style.backgroundColor = '';
            handleFile(e.dataTransfer.files[0]);
        });

        imageInput.addEventListener('change', e => handleFile(e.target.files[0]));

        uploadBox.addEventListener('paste', e => {
            const items = e.clipboardData.items;
            for (let item of items) {
                if (item.type.startsWith('image/')) {
                    const file = item.getAsFile();
                    handleFile(file);
                }
            }
        });

        function handleFile(file) {
            const reader = new FileReader();
            reader.onload = e => imageBase64.value = e.target.result;
            reader.readAsDataURL(file);
        }
    </script>
</body>
</html>
